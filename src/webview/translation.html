<!DOCTYPE html>
<html>

<head>
    <title>Translation</title>
    <link rel="stylesheet" href="vscode-codicons" />
    <link rel="stylesheet" href="css/common.css" />
    <style>
        .headLeft,
        .headCenter,
        .headRight {
            display: inline-block;
        }

        .textArea {
            width: 100%;
        }

        .headCenter {
            width: 30px;
            text-align: center;
            vertical-align: top;
        }

        .headLeft,
        .headRight {
            width: calc(50% - 15px);
            vertical-align: top;
        }

        .headOperation {
            margin: 5px 0px;
        }

        .history {
            margin: 7px 0px 20px 0px;
        }

        .translate {
            margin-bottom: 20px;
        }

        .langSelect {
            width: 150px;
            margin-right: 10px;
        }

        .historyPanel {
            z-index: 3;
            position: absolute;
            margin-left: 20px;
            border: 1px solid;
            background-color: var(--vscode-editor-background);
            width: 150px;
            max-height: 400px;
            text-align: left;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .historyItem {
            padding: 3px 5px;
            cursor: pointer;
        }

        .historyItem:hover {
            background-color: var(--vscode-button-background);
        }

        .operationButton {
            margin-right: 5px;
        }

        .operationGroup {
            display: inline-block;
        }

        .pronunceButton,
        .pronunce {
            vertical-align: middle;
        }

        .pronunceButton {
            margin-right: 5px;
        }

        .pronunce.withSrc {
            margin-right: 5px;
        }

        .pronunceSourceLang {
            color: var(--vscode-charts-green);
        }

        .exampleIndex {
            margin-right: 10px;
        }

        .exampleItem {
            margin: 10px 0px;
        }

        .dictPos {
            margin-bottom: 5px;
            color: var(--vscode-charts-green);
        }

        .alterPart {
            color: var(--vscode-charts-green);
        }

        .dictEntry {
            margin-bottom: 10px;
        }

        .dictWord {
            padding-right: 10px;
            word-break: keep-all;
            vertical-align: top;
            color: var(--vscode-charts-blue);
        }

        .dictReverse {
            vertical-align: top;
        }

        .dictPosIcon {
            margin-right: 5px;
        }

        .alterItem {
            margin-bottom: 5px;
        }

        .alterTitle {
            margin-bottom: 5px;
        }

        .link {
            cursor: pointer;
        }

        .link:hover {
            border: 1px solid;
        }

        .defineTitle {
            word-break: keep-all;
            vertical-align: top;
            color: var(--vscode-charts-blue);
        }

        [v-cloak] {
            display: none;
        }

        .pronounceFrame {
            max-height: 150px;
            overflow: auto;
        }
    </style>
</head>

<body>

    <div id="app" v-cloak>
        <div>
            <form>
                <div class="headLeft">
                    <div class="headOperation">
                        <vscode-dropdown class="langSelect" v-model="state.sourceLang"
                            @change="sourceLangChange($event.target.value)">
                            <vscode-option v-for="(i, index) in sourceLangList" :key="i.key + index" :value="i.key"
                                :title="i.label">{{i.label}}</vscode-option>
                        </vscode-dropdown>
                        <div class="operationGroup">
                            <vscode-button class="operationButton first" appearance="icon" title="Copy"
                                @click="copyAction('source')">
                                <span class="codicon codicon-repo-pull"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Paste"
                                @click="pasteAction('source')">
                                <span class="codicon codicon-repo-push"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Clear"
                                @click="clearAction('source')">
                                <span class="codicon codicon-trash"></span>
                            </vscode-button>
                        </div>
                    </div>

                    <div>
                        <vscode-text-area v-model="state.source" class="textArea" rows="8"
                            placeholder="Original Text">
                        </vscode-text-area>
                    </div>

                    <div>
                        <div class="pronounceFrame">
                            <vscode-button class="pronunceButton" appearance="icon" @click="pronunciation('source')">
                                <span class="codicon codicon-unmute"></span>
                            </vscode-button>
                            <span class="pronunce withSrc">{{sourcePronunce}}</span>
                            <span class="pronunceSourceLang">{{pronunceSourceLang}}</span>
                        </div>
                    </div>
                </div>

                <div class="headCenter">
                    <div class="history">
                        <vscode-button v-if="isUnmark" appearance="icon" title="Mark" @click="mark">
                            <span class="codicon codicon-star-empty"></span>
                        </vscode-button>
                        <vscode-button v-else appearance="icon" title="Unmark" @click="unmark(state.source)">
                            <span class="codicon codicon-star-full"></span>
                        </vscode-button>
                    </div>
                    <div class="translate">
                        <vscode-button appearance="icon" title="Translate" @click="query()">
                            <span class="codicon codicon-play"></span>
                        </vscode-button>
                    </div>
                    <div>
                        <vscode-button appearance="icon" title="Swap" @click="swapAction()">
                            <span class="codicon codicon-arrow-swap"></span>
                        </vscode-button>
                    </div>
                </div>

                <div class="headRight">
                    <div class="headOperation">
                        <vscode-dropdown class="langSelect" v-model="state.targetLang"
                            @change="targetLangChange($event.target.value)">
                            <vscode-option v-for="(i, index) in targetLangList" :key="i.key + index" :value="i.key"
                                :title="i.label">{{i.label}}</vscode-option>
                        </vscode-dropdown>
                        <div class="operationGroup">
                            <vscode-button class="operationButton first" appearance="icon" title="Copy"
                                @click="copyAction('target')">
                                <span class="codicon codicon-repo-pull"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Paste"
                                @click="pasteAction('target')">
                                <span class="codicon codicon-repo-push"></span>
                            </vscode-button>
                            <vscode-button class="operationButton" appearance="icon" title="Clear"
                                @click="clearAction('target')">
                                <span class="codicon codicon-trash"></span>
                            </vscode-button>
                        </div>
                    </div>

                    <div>
                        <vscode-text-area v-model="state.target" class="textArea" rows="8"
                            placeholder="Translation">
                        </vscode-text-area>
                    </div>

                    <div>
                        <div class="pronounceFrame">
                            <vscode-button class="pronunceButton" appearance="icon" @click="pronunciation('target')">
                                <span class="codicon codicon-unmute"></span>
                            </vscode-button>
                            <span class="pronunce">{{targetPronounce}}</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <vscode-divider></vscode-divider>

        <div>
            <vscode-progress-ring v-if="state.loading"></vscode-progress-ring>
            <vscode-panels v-else :activeid="state.currentTab">
                <vscode-panel-tab id="history" @click="tabChange('history')">History</vscode-panel-tab>
                <vscode-panel-tab id="favorite" @click="tabChange('favorite')">Bookmark</vscode-panel-tab>
                <vscode-panel-tab id="translation" @click="tabChange('translation')">Tanslation</vscode-panel-tab>
                <vscode-panel-tab id="definition" @click="tabChange('definition')">Definition</vscode-panel-tab>
                <vscode-panel-tab id="example" @click="tabChange('example')">Example</vscode-panel-tab>

                <vscode-panel-view aria-labelledby="history">
                    <div>
                        <div style="margin-bottom: 10px;">
                            <vscode-button @click="clearHistory" >
                                <span slot="start" class="codicon codicon-trash"></span>Clear
                            </vscode-button>
                        </div>
                        <div v-if="state.history.history.length > 0">
                            <div class="exampleItem" v-for="(i, index) in state.history?.history"
                                :key="i.text + index">
                                <vscode-badge class="exampleIndex">{{index + 1}}</vscode-badge>
                                <span class="link" @click="historyClick(i)">{{ i.text }}</span>
                            </div>
                        </div>
                        <div v-else>
                            <div>No Data</div>
                        </div>
                    </div>
                </vscode-panel-view>

                <vscode-panel-view aria-labelledby="favorite">
                    <div v-if="state.favorite.favorite.length > 0">
                        <div class="exampleItem" v-for="(i, index) in state.favorite?.favorite"
                            :key="i.text + index">
                            <vscode-badge class="exampleIndex">{{index + 1}}</vscode-badge>
                            <vscode-tag style="margin-right: 10px;cursor: pointer;" @click="unmark(i.text)">Remove</vscode-tag>
                            <span class="link" @click="favoriteClick(i)">{{ i.text }}</span>
                        </div>
                    </div>
                    <div v-else>
                        <div>No Data</div>
                    </div>
                </vscode-panel-view>

                <vscode-panel-view aria-labelledby="translation">
                    <div v-if="state.result?.dict">
                        <div class="dictItem" v-for="(i, index) in state.result.dict" :key="i.pos + index">
                            <div class="dictPos"><span
                                    class="codicon codicon-debug-breakpoint-log dictPosIcon"></span>{{i.pos}}</div>
                            <div class="dictEntry">
                                <table>
                                    <tbody>
                                        <tr v-for="(j, jIndex) in i.entry" :key="j.word + jIndex">
                                            <td class="dictWord"><span class="link"
                                                    @click="toSwapQuery(j.word)">{{j.word}}</span></td>
                                            <td class="dictReverse">
                                                <span v-html="getDictReverse(j.reverse_translation)"></span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <div v-if="!alternativeTranslation.isEmpty">
                            <div class="alterTitle">Alternative:</div>
                            <template v-if="alternativeTranslation.isMultipart">
                                <div v-for="(i, index) in alternativeTranslation.data"
                                :key="index">
                                    <div class="alterPart">Part: {{ index + 1 }}</div>
                                    <div v-for="(j, jIndex) in i" :key="jIndex">
                                        <div class="alterItem"><span
                                            class="codicon codicon-debug-breakpoint-log dictPosIcon"></span>{{j}}
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <template v-else >
                                <div v-for="(i, index) in alternativeTranslation.data"
                                :key="index">
                                    <div class="alterItem"><span
                                            class="codicon codicon-debug-breakpoint-log dictPosIcon"></span>{{i}}
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div v-else>No Data</div>
                    </div>
                </vscode-panel-view>

                <vscode-panel-view aria-labelledby="definition">
                    <div v-if="state.result?.definitions">
                        <div class="exampleItem" v-for="(i, index) in state.result.definitions" :key="i.pos + index">
                            <div class="dictPos"><span
                                    class="codicon codicon-debug-breakpoint-log dictPosIcon"></span>{{i.pos}}</div>
                            <div class="dictEntry">
                                <table>
                                    <tbody>
                                        <template v-for="(j, jIndex) in i.entry" :key="j.gloss + jIndex">
                                            <tr>
                                                <td class="dictWord" rowspan="3">
                                                    <vscode-badge>{{jIndex + 1}}</vscode-badge>
                                                </td>
                                                <td class="defineTitle">Definition:</td>
                                                <td>{{j.gloss}}</td>
                                            </tr>
                                            <tr>
                                                <td class="defineTitle">Example:</td>
                                                <td>{{j.example}}</td>
                                            </tr>
                                            <tr>
                                                <td class="defineTitle">Synonym:</td>
                                                <td>
                                                    <span
                                                        v-html="getDictReverse(getSynsetsByDefineId(j.definition_id))"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <div>No Data</div>
                    </div>
                </vscode-panel-view>

                <vscode-panel-view aria-labelledby="example">
                    <div v-if="state.result?.examples">
                        <div class="exampleItem" v-for="(i, index) in state.result.examples.example"
                            :key="i.text + index">
                            <vscode-badge class="exampleIndex">{{index + 1}}</vscode-badge>
                            <span v-html="renderCode(i.text)"></span>
                        </div>
                    </div>
                    <div v-else>
                        <div>No Data</div>
                    </div>
                </vscode-panel-view>
            </vscode-panels>
        </div>
    </div>

    <script type="module" src="vscode-webview-ui-toolkit"></script>
    <script src="js/vue@next.js"></script>
    <script src="js/language.js"></script>
    <script>
        'use strict';
        const vscode = acquireVsCodeApi();

        const app = Vue.createApp({
            data() {
                return {
                    state: {
                        sourceLang: 'auto',
                        targetLang: 'en',
                        source: null,
                        target: null,
                        result: null,
                        // history: [],
                        loading: false,
                        temp: null,
                        currentTab: 'history',
                        history: {history: []},
                        favorite: {favorite: []},
                        maxHistory: 50,
                    },
                    sourceLangList: SOURCE_LANGUAGE,
                    targetLangList: TARGET_LANGUAGE,
                    sound: null,
                };
            },
            created() {
                this.$nextTick(() => {
                    let preState = vscode.getState();
                    if (preState) this.state = preState;
                    vscode.postMessage({
                        operation: 'getQueryText',
                    });
                });
            },
            computed: {
                synsetsEntries() {
                    let result = [];
                    if (this.state.result && this.state.result.synsets) {
                        this.state.result.synsets.forEach(i => {
                            result = [...result, ...i.entry];
                        });
                    }
                    return result;
                },
                sourcePronunce() {
                    return this.state.result ?
                        this.state.result.sentences[this.state.result.sentences.length - 1] ?
                            this.state.result.sentences[this.state.result.sentences.length - 1].src_translit : '' : '';
                },
                targetPronounce() {
                    return this.state.result ?
                        this.state.result.sentences[this.state.result.sentences.length - 1] ?
                            this.state.result.sentences[this.state.result.sentences.length - 1].translit : '' : '';
                },
                pronunceSourceLang() {
                    if (!this.state.result) {
                        return '';
                    }
                    for (let i in this.sourceLangList) {
                        if (this.sourceLangList[i].key === this.state.result.src) {
                            return `(${this.sourceLangList[i].label})`;
                        }
                    }
                    return '';
                },
                alternativeTranslation() {
                    let result = {
                            isEmpty: false,
                            data: [],
                        }
                    if (this.state.result?.alternative_translations && this.state.result.alternative_translations.length > 0) {
                        if (this.state.result.alternative_translations.length > 1) {
                            result.isMultipart = true
                            this.state.result.alternative_translations.forEach(j => {
                                result.data.push(j.alternative.map(i => i.word_postproc))
                            })
                        }else {
                            result.isMultipart = false
                            this.state.result.alternative_translations[0].alternative.forEach(i => result.data.push(i.word_postproc))
                        }
                    }else {
                        result.isEmpty = true
                    }
                    return result
                },
                isUnmark() {
                    return this.state.favorite.favorite.map(i => i.text).indexOf(this.state.source) < 0
                },
            },
            watch: {
                'state.source'() {
                    this.setState();
                },
                'state.target'() {
                    this.setState();
                },
            },
            methods: {
                tabChange(id) {
                    this.state.currentTab = id;
                    vscode.setState(this.state);
                },
                getSynsetsByDefineId(id) {
                    let result = [];
                    this.synsetsEntries.forEach(i => {
                        if (i.definition_id === id) {
                            result = [...result, ...i.synonym];
                        }
                    });
                    return result;
                },
                getDictReverse(arr) {
                    return arr.map(i => `<span class="link" onclick="appInstance.toQuery('${i}')">${i}</span>`).join(', ');
                },
                toQuery(text) {
                    this.state.source = text;
                    this.state.sourceLang = this.state.temp.sourceLang;
                    this.state.targetLang = this.state.temp.targetLang;
                    this.query();
                },
                toSwapQuery(text) {
                    this.state.target = text;
                    this.state.sourceLang = this.state.temp.sourceLang;
                    this.state.targetLang = this.state.temp.targetLang;
                    this.swapAction();
                },
                renderCode(text) {
                    return text.replaceAll('<b>', '<code>').replaceAll('</b>', '</code>');
                },
                setState() {
                    vscode.setState(this.state);
                },
                sourceLangChange(value) {
                    this.state.sourceLang = value;
                    this.setState();
                },
                targetLangChange(value) {
                    this.state.targetLang = value;
                    this.setState();
                },
                copyAction(target) {
                    if (this.state[target]) {
                        window.navigator.clipboard.writeText(this.state[target]);
                    }
                },
                pasteAction(target) {
                    window.navigator.clipboard.readText().then(text => {
                        if (text) {
                            this.state[target] = text;
                        }
                    });
                },
                swapAction() {
                    let t = this.state.source;
                    this.state.source = this.state.target;
                    this.state.target = t;
                    if (this.state.sourceLang === 'auto') {
                        if (this.state.result && this.state.result.src) {
                            this.state.sourceLang = this.state.targetLang;
                            this.state.targetLang = this.state.result.src;
                        }
                    } else {
                        t = this.state.sourceLang;
                        this.state.sourceLang = this.state.targetLang;
                        this.state.targetLang = t;
                    }
                    this.query();
                },
                pronunciation(type) {
                    if (this.state.temp) {
                        switch (type) {
                            case 'source': {
                                vscode.postMessage({
                                    operation: 'getTts',
                                    parameter: {
                                        sl: this.state.temp.sourceLang,
                                        tl: this.state.temp.sourceLang,
                                        q: this.state.temp.source,
                                    },
                                });
                                break;
                            }
                            case 'target': {
                                vscode.postMessage({
                                    operation: 'getTts',
                                    parameter: {
                                        sl: this.state.temp.targetLang,
                                        tl: this.state.temp.targetLang,
                                        q: this.state.temp.target,
                                    },
                                });
                                break;
                            }
                        }
                    }
                },
                clearAction(target) {
                    this.state[target] = null;
                },
                init(initState) {
                    this.state.sourceLang = initState.sl;
                    this.state.targetLang = initState.tl;
                    this.state.source = initState.q;
                    this.state.history = initState.history
                    this.state.favorite = initState.favorite
                    this.state.maxHistory = initState.maxHistory
                    this.setState();
                    this.query();
                },
                query() {
                    if (this.state.source) {
                        this.state.target = null;
                        this.state.result = null;
                        this.state.loading = true;
                        vscode.postMessage({
                            operation: 'getTranslate',
                            parameter: {
                                hl: this.state.targetLang,
                                tl: this.state.targetLang,
                                sl: this.state.sourceLang,
                                q: this.state.source,
                            },
                        });
                        this.state.currentTab = "translation"
                        if (this.state.history.history.length >= this.state.maxHistory) {
                            this.state.history.history.pop()
                        }
                        this.state.history.history.unshift({
                            text: this.state.source,
                            sl: this.state.sourceLang,
                            tl: this.state.targetLang,
                        })
                        vscode.postMessage({
                            operation: 'saveHistory',
                            parameter: JSON.parse(JSON.stringify(this.state.history)),
                        });
                        this.setState();
                    }
                },
                receiveMessage(message) {
                    switch (message.operation) {
                        case 'init': {
                            this.init(message.parameter);
                            break;
                        }
                        case 'query': {
                            if (message.parameter.q) this.state.source = message.parameter.q;
                            this.query();
                            break;
                        }
                        case 'receiveTranslation': {
                            this.state.result = message.parameter;
                            this.state.target = message.parameter.sentences.filter(i => i.trans).map(i => i.trans).join("");
                            this.state.temp = {
                                source: this.state.result.sentences.filter(i => i.orig).map(i => i.orig).join(""),
                                target: this.state.result.sentences.filter(i => i.trans).map(i => i.trans).join(""),
                                sourceLang: this.state.result.src,
                                targetLang: this.state.targetLang,
                            };
                            this.state.loading = false;
                            this.setState();
                            break;
                        }
                        case "playTts": {
                            let ttsFile = "tts.mp3"
                            new Audio(`${ttsFile}?v=${Math.random()}`).play()
                            break;
                        }
                    }
                },
                historyClick(row) {
                    this.state.source = row.text;
                    this.state.sourceLang = row.sl
                    this.state.targetLang = row.tl
                    this.query()
                },
                favoriteClick(row) {
                    this.state.source = row.text;
                    this.state.sourceLang = row.sl
                    this.state.targetLang = row.tl
                    this.query()
                },
                clearHistory() {
                    this.state.history.history = []
                    vscode.postMessage({
                        operation: 'saveHistory',
                        parameter: JSON.parse(JSON.stringify(this.state.history)),
                    })
                    this.setState()
                },
                mark() {
                    this.state.favorite.favorite.unshift({
                        text: this.state.source,
                        sl: this.state.sourceLang,
                        tl: this.state.targetLang,
                    })
                    vscode.postMessage({
                        operation: 'saveFavorite',
                        parameter: JSON.parse(JSON.stringify(this.state.favorite)),
                    })
                    this.setState()
                },
                unmark(text) {
                    this.state.favorite.favorite = this.state.favorite.favorite.filter(i => i.text !== text)
                    vscode.postMessage({
                        operation: 'saveFavorite',
                        parameter: JSON.parse(JSON.stringify(this.state.favorite)),
                    })
                    this.setState()
                },
            },
        });
        app.config.compilerOptions.isCustomElement = tag => tag.startsWith('vscode-');
        const appInstance = app.mount('#app');

        window.addEventListener('message', event => {
            appInstance.receiveMessage(event.data);
        });
    </script>
</body>

</html>